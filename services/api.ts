// services/api.ts
// ç»Ÿä¸€çš„ API è°ƒç”¨æœåŠ¡

import { API_CONFIG } from '../config/apiConfig';

const API_BASE_URL = API_CONFIG.BASE_URL;

export interface OCRResult {
  text: string;
  bounding: {
    left: number;
    top: number;
    width: number;
    height: number;
  };
  confidence?: number;
}

export interface OCRResponse {
  success: boolean;
  results: OCRResult[];
  error?: string;
}

export interface TranslationResult {
  success: boolean;
  translatedText: string;
  originalText: string;
  sourceLanguage?: string;
  targetLanguage: string;
  error?: string;
}

export interface BatchTranslationResponse {
  success: boolean;
  results: TranslationResult[];
  error?: string;
}

/**
 * è°ƒç”¨åç«¯ OCR API
 * @param imageBase64 base64 ç¼–ç çš„å›¾ç‰‡æ•°æ®
 * @returns OCR è¯†åˆ«ç»“æœ
 */
export const callOcrApi = async (imageBase64: string): Promise<OCRResponse> => {
  try {
    console.log('ğŸ” è°ƒç”¨ OCR API...');

    const response = await fetch(`${API_BASE_URL}/api/ocr`, {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json',
          },
          body: JSON.stringify({
        imageBase64,
          }),
    });

      if (!response.ok) {
      throw new Error(`OCR API è¯·æ±‚å¤±è´¥: ${response.status} ${response.statusText}`);
      }

      const data = await response.json();
      
    if (!data.success) {
      throw new Error(data.error || 'OCR è¯†åˆ«å¤±è´¥');
      }

    console.log('âœ… OCR API è°ƒç”¨æˆåŠŸï¼Œè¯†åˆ«åˆ°', data.results.length, 'ä¸ªæ–‡æœ¬å—');
      
      return {
        success: true,
      results: data.results,
      };
    } catch (error) {
    console.error('âŒ OCR API è°ƒç”¨å¤±è´¥:', error);
      return {
        success: false,
      results: [],
      error: error instanceof Error ? error.message : 'OCR API è°ƒç”¨å¤±è´¥',
    };
  }
};

/**
 * è°ƒç”¨åç«¯ç¿»è¯‘ APIï¼ˆå•ä¸ªæ–‡æœ¬ï¼‰
 * @param text è¦ç¿»è¯‘çš„æ–‡æœ¬
 * @param targetLanguage ç›®æ ‡è¯­è¨€
 * @param sourceLanguage æºè¯­è¨€ï¼ˆå¯é€‰ï¼‰
 * @returns ç¿»è¯‘ç»“æœ
 */
export const callTranslateApi = async (
  text: string,
  targetLanguage: string = 'zh-CN',
  sourceLanguage?: string
): Promise<TranslationResult> => {
  try {
    console.log('ğŸŒ è°ƒç”¨ç¿»è¯‘ API:', text, '->', targetLanguage);

    const response = await fetch(`${API_BASE_URL}/api/translate`, {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json',
          },
      body: JSON.stringify({
        texts: text,
        targetLanguage,
        sourceLanguage,
        isBatch: false,
      }),
    });

      if (!response.ok) {
      throw new Error(`ç¿»è¯‘ API è¯·æ±‚å¤±è´¥: ${response.status} ${response.statusText}`);
      }

      const data = await response.json();
      
    if (!data.success) {
      throw new Error(data.error || 'ç¿»è¯‘å¤±è´¥');
      }

    console.log('âœ… ç¿»è¯‘ API è°ƒç”¨æˆåŠŸ:', text, '->', data.translatedText);
      
      return {
        success: true,
      translatedText: data.translatedText,
      originalText: data.originalText,
      sourceLanguage: data.sourceLanguage,
      targetLanguage: data.targetLanguage,
      };
    } catch (error) {
    console.error('âŒ ç¿»è¯‘ API è°ƒç”¨å¤±è´¥:', error);
      return {
        success: false,
      translatedText: text,
      originalText: text,
      targetLanguage,
      error: error instanceof Error ? error.message : 'ç¿»è¯‘ API è°ƒç”¨å¤±è´¥',
    };
  }
};

/**
 * è°ƒç”¨åç«¯ç¿»è¯‘ APIï¼ˆæ‰¹é‡æ–‡æœ¬ï¼‰
 * @param texts è¦ç¿»è¯‘çš„æ–‡æœ¬æ•°ç»„
 * @param targetLanguage ç›®æ ‡è¯­è¨€
 * @param sourceLanguage æºè¯­è¨€ï¼ˆå¯é€‰ï¼‰
 * @returns æ‰¹é‡ç¿»è¯‘ç»“æœ
 */
export const callBatchTranslateApi = async (
  texts: string[],
  targetLanguage: string = 'zh-CN',
  sourceLanguage?: string
): Promise<TranslationResult[]> => {
  try {
    console.log('ğŸŒ è°ƒç”¨æ‰¹é‡ç¿»è¯‘ API:', texts.length, 'ä¸ªæ–‡æœ¬');
    console.log('ğŸ“ ç¿»è¯‘æ–‡æœ¬å†…å®¹:', texts);
    console.log('ğŸ¯ ç›®æ ‡è¯­è¨€:', targetLanguage, 'æºè¯­è¨€:', sourceLanguage);

    const response = await fetch(`${API_BASE_URL}/api/translate`, {
      method: 'POST',
      headers: {
        'Content-Type': 'application/json',
      },
      body: JSON.stringify({
        texts,
        targetLanguage,
        sourceLanguage,
        isBatch: true,
      }),
    });

    if (!response.ok) {
      throw new Error(`æ‰¹é‡ç¿»è¯‘ API è¯·æ±‚å¤±è´¥: ${response.status} ${response.statusText}`);
    }

    const data = await response.json();

    if (!data.success) {
      throw new Error(data.error || 'æ‰¹é‡ç¿»è¯‘å¤±è´¥');
    }

    console.log('âœ… æ‰¹é‡ç¿»è¯‘ API è°ƒç”¨æˆåŠŸ');

    return data.results;
    } catch (error) {
    console.error('âŒ æ‰¹é‡ç¿»è¯‘ API è°ƒç”¨å¤±è´¥:', error);
    
    // å¦‚æœæ‰¹é‡ç¿»è¯‘å¤±è´¥ï¼Œå›é€€åˆ°å•ä¸ªç¿»è¯‘
    const results: TranslationResult[] = [];
    for (const text of texts) {
      const result = await callTranslateApi(text, targetLanguage, sourceLanguage);
      results.push(result);
    }
    return results;
  }
};