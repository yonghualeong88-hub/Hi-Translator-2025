# 🧪 离线翻译测试指南

## 📱 测试准备

### 1. 启动应用
应用正在启动中... 请等待编译完成并在设备上安装。

### 2. 查看初始化日志
在 Metro 控制台或 Logcat 中查找以下日志：
```
✅ TranslationModeManager 初始化完成
✅ OfflineTranslationService 初始化完成
```

如果看到这两条日志，说明服务初始化成功！

---

## 🔧 测试步骤

### 步骤 1: 清除旧缓存（可选，建议执行）

在应用中打开开发者菜单（摇一摇设备），选择 "Debug JS Remotely" 或打开 React Native Debugger，在控制台执行：

```javascript
// 清除语言包缓存
await AsyncStorage.removeItem('downloaded_language_packs');

// 清除翻译模式设置
await AsyncStorage.removeItem('translationMode');

// 重启应用
// 关闭应用后重新打开
```

或者在应用的设置页面查找"清除缓存"功能。

---

### 步骤 2: 下载语言包（在线状态）

1. **打开应用，确保网络连接正常**

2. **进入设置 → 语言包管理**
   - 路径：设置页面 → "语言包管理" 或 "Offline Language Packs"

3. **下载测试语言包**
   - 选择 `中文(简体)` 或 `Chinese (Simplified)`
   - 点击下载按钮
   
4. **观察日志输出**
   ```
   🔄 开始真正下载 zh-CN 语言包（ML Kit: zh）
   🔄 下载语言包: zh-CN → ML Kit: zh
   ✅ zh-CN 语言包真正下载完成（存储为 zh）
   📱 加载已下载的语言包: zh
   ```

5. **等待下载完成**
   - 应该显示 100% 进度
   - 状态变为 "已下载"

---

### 步骤 3: 切换到离线模式

**方法 1: 关闭网络**
- 打开飞行模式
- 或关闭 WiFi 和移动数据

**方法 2: 在应用中切换（如果有设置）**
- 进入设置
- 找到 "翻译模式" 或 "Translation Mode"
- 选择 "离线模式" 或 "Offline"

---

### 步骤 4: 测试离线翻译

1. **打开文本翻译页面**
   - 进入 "文本" 或 "Text" 标签页

2. **设置语言对**
   - 源语言：English (en)
   - 目标语言：中文(简体) (zh-CN)

3. **输入测试文本**
   ```
   Hello
   ```

4. **点击翻译**

5. **查看日志输出**（应该看到）：
   ```
   📱 离线翻译: "Hello" (en/en → zh-CN/zh)
   🔍 离线翻译检查: en(en) → zh(zh) (已下载)
   📦 已下载语言包: ['zh']
   ✅ 模型已验证: en → zh
   🤖 使用 ML Kit 翻译...
   🔄 翻译: en(en) → zh-CN(zh)
   ✅ ML Kit 翻译成功: 你好
   ```

6. **验证翻译结果**
   - 应该显示：`你好`
   - 没有网络错误提示
   - 没有"语言包未下载"错误

---

## ✅ 成功标志

### 下载阶段
- ✅ 日志显示 `zh-CN → ML Kit: zh`
- ✅ 存储为 `zh`（而非 `zh-CN`）
- ✅ 下载进度显示 100%
- ✅ 状态变为"已下载"

### 翻译阶段
- ✅ 离线状态下能正常翻译
- ✅ 日志显示使用映射后的语言码 `zh`
- ✅ 模型验证通过
- ✅ 翻译成功返回正确结果

---

## 🧪 详细测试用例

### 测试用例 1: 英文 → 中文
```
输入: Hello
期望输出: 你好

输入: Good morning
期望输出: 早上好

输入: Thank you
期望输出: 谢谢
```

### 测试用例 2: 中文 → 英文
**注意：需要先下载 `en` 语言包（如果翻译到英文）**

```
输入: 你好
期望输出: Hello

输入: 再见
期望输出: Goodbye
```

### 测试用例 3: 长句子
```
输入: How are you today?
期望输出: 你今天好吗？

输入: The weather is very nice.
期望输出: 天气很好。
```

---

## ❌ 常见问题排查

### 问题 1: 提示"语言包未下载"

**可能原因：**
- 语言包下载失败
- 网络中断导致下载未完成
- 缓存未更新

**解决方法：**
1. 检查日志，确认下载是否成功
2. 重新下载语言包
3. 清除缓存后重试
4. 检查设备存储空间是否充足

---

### 问题 2: 显示"模型未下载或未初始化"

**可能原因：**
- ML Kit 模型文件不存在
- Google Play Services 未安装或版本过低
- 设备不支持 ML Kit

**解决方法：**
1. 确认设备已安装 Google Play Services
2. 更新 Google Play Services 到最新版本
3. 检查设备兼容性（需要 Android 5.0+）
4. 查看原生日志：`adb logcat | grep MLKit`

---

### 问题 3: 翻译结果为空

**可能原因：**
- ML Kit 翻译返回空结果
- 语言对不支持
- 模型文件损坏

**解决方法：**
1. 检查日志中的错误信息
2. 删除并重新下载语言包
3. 尝试其他语言对
4. 查看原生错误日志

---

### 问题 4: 初始化失败

**可能原因：**
- translationModeManager 未就绪
- AsyncStorage 访问失败
- 依赖服务未加载

**解决方法：**
1. 查看应用启动日志
2. 确认看到初始化成功日志
3. 重启应用
4. 检查 app/_layout.tsx 中的初始化代码

---

## 📊 日志检查清单

启动应用后，按顺序检查以下日志：

1. **初始化日志**
   - [ ] `✅ TranslationModeManager 初始化完成`
   - [ ] `✅ OfflineTranslationService 初始化完成`

2. **下载日志**
   - [ ] `🔄 下载语言包: zh-CN → ML Kit: zh`
   - [ ] `✅ zh-CN 语言包真正下载完成（存储为 zh）`

3. **翻译日志**
   - [ ] `📱 离线翻译: "..." (en/en → zh-CN/zh)`
   - [ ] `🔍 离线翻译检查: en(en) → zh(zh) (已下载)`
   - [ ] `✅ 模型已验证: en → zh`
   - [ ] `✅ ML Kit 翻译成功: ...`

如果所有日志都正常，说明离线翻译功能完美运行！

---

## 🎯 高级测试

### 1. 多语言包测试
下载多个语言包（如 ja, ko, es），测试不同语言对：
- en → ja
- en → ko
- zh-CN → ja

### 2. 网络切换测试
- 在线状态：验证使用在线翻译
- 离线状态：验证使用离线翻译
- 自动模式：验证根据网络自动切换

### 3. 语言包管理测试
- 下载语言包
- 删除语言包
- 重新下载
- 验证状态同步

### 4. 边界条件测试
- 空文本
- 超长文本（1000+ 字符）
- 特殊字符
- emoji 表情

---

## 📝 测试报告模板

完成测试后，可以填写以下报告：

```
### 测试环境
- 设备型号: _______
- Android 版本: _______
- Google Play Services 版本: _______
- 应用版本: _______

### 测试结果
- [ ] 初始化成功
- [ ] 语言包下载成功
- [ ] 离线翻译成功
- [ ] 语言码映射正确
- [ ] 模型验证通过

### 发现的问题
1. _______
2. _______

### 日志截图
（粘贴关键日志）

### 备注
_______
```

---

## 🚀 开始测试

1. ✅ 应用正在启动...
2. ⏳ 等待编译完成
3. ⏳ 安装到设备
4. ✅ 按照上述步骤开始测试

祝测试顺利！如有问题，请查看日志并参考故障排查部分。🎉

